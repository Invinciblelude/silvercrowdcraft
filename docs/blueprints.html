<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Blueprint Viewer</title>
  <script src="assets/shared-nav.js?v=3"></script>
  <style>
    body {background:#0a0e27; color:#e8eef5}
    .container {max-width:1400px; margin:0 auto; padding:16px 16px 100px}
    .back-btn {display:inline-block; background:#303947; color:#e8eef5; padding:10px 20px; border-radius:6px; text-decoration:none; margin-bottom:16px}
    .back-btn:hover {background:#3d4757}
    
    .sidebar {
      position:fixed;
      left:0;
      top:72px;
      width:300px;
      height:calc(100vh - 152px);
      background:#12161b;
      border-right:1px solid #1f2630;
      overflow-y:auto;
      padding:16px;
    }
    
    .main-content {margin-left:320px}
    
    .filters {margin-bottom:20px}
    .filters input, .filters select {
      width:100%;
      background:#0f1317;
      border:1px solid #303947;
      color:#e8eef5;
      padding:10px;
      border-radius:6px;
      margin-bottom:10px;
    }
    
    .category-list {margin-top:20px}
    .category-item {
      padding:10px;
      border-radius:4px;
      cursor:pointer;
      margin-bottom:6px;
      background:#0f1317;
      border-left:3px solid #667eea;
    }
    .category-item:hover {background:#1a1f2e}
    .category-item.active {background:#667eea; color:#fff}
    .category-count {font-size:12px; opacity:0.8; margin-left:8px}
    
    .blueprints-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));
      gap:16px;
    }
    
    .blueprint-card {
      background:#12161b;
      border-radius:8px;
      overflow:hidden;
      border:1px solid #1f2630;
      cursor:pointer;
      transition:transform 0.2s, box-shadow 0.2s;
    }
    .blueprint-card:hover {
      transform:translateY(-4px);
      box-shadow:0 8px 16px rgba(0,0,0,0.4);
    }
    .blueprint-img {
      width:100%;
      height:220px;
      object-fit:contain;
      background:#0a0e27;
    }
    .blueprint-info {padding:12px}
    .blueprint-sheet {font-size:14px; color:#667eea; font-weight:700}
    .blueprint-title {font-size:13px; color:#e8eef5; margin-top:4px}
    .blueprint-category {font-size:11px; color:#8a98ab; margin-top:8px}
    
    .modal {
      display:none;
      position:fixed;
      z-index:2000;
      left:0;
      top:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.95);
    }
    .modal-content {
      position:relative;
      margin:auto;
      padding:20px;
      width:90%;
      max-width:1200px;
      height:90vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    }
    .modal-close {
      position:absolute;
      top:20px;
      right:40px;
      color:#fff;
      font-size:40px;
      font-weight:bold;
      cursor:pointer;
    }
    .modal-img {
      max-width:100%;
      max-height:80vh;
      object-fit:contain;
    }
    .modal-info {
      color:#fff;
      margin-top:20px;
      text-align:center;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        position:static;
        width:100%;
        height:auto;
        border-right:none;
        border-bottom:1px solid #1f2630;
      }
      .main-content {margin-left:0; margin-top:20px}
    }
  </style>
</head>
<body data-jsdom-page="plans" data-jsdom-title="üìê Blueprints">
  <div class="sidebar">
    <div class="filters">
      <input type="text" id="searchInput" placeholder="üîç Search blueprints..." />
      <select id="categoryFilter">
        <option value="">All Categories</option>
      </select>
    </div>
    <div class="category-list" id="categoryList"></div>
  </div>
  
  <div class="main-content">
    <div class="container">
      <a href="project.html" class="back-btn">‚Üê Back to Tasks</a>
      <div class="blueprints-grid" id="blueprintsGrid"></div>
    </div>
  </div>
  
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <img id="modalImg" class="modal-img" src="" alt="">
      <div id="modalInfo" class="modal-info"></div>
    </div>
  </div>

  <script>
    let allPages = [];
    let currentCategory = '';
    
    async function loadBlueprints() {
      try {
        const response = await fetch('assets/blueprint_data.json');
        const data = await response.json();
        allPages = data.pages;
        
        // Populate category filter
        const categories = Object.keys(data.by_category).sort();
        const categoryFilter = document.getElementById('categoryFilter');
        categoryFilter.innerHTML = '<option value="">All Categories</option>' +
          categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        
        // Render category list
        const categoryList = document.getElementById('categoryList');
        categoryList.innerHTML = categories.map(cat => {
          const count = data.by_category[cat].length;
          return `
            <div class="category-item" data-category="${cat}">
              ${cat} <span class="category-count">(${count})</span>
            </div>
          `;
        }).join('');
        
        // Add click handlers
        document.querySelectorAll('.category-item').forEach(item => {
          item.addEventListener('click', () => {
            document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            currentCategory = item.dataset.category;
            filterBlueprints();
          });
        });
        
        renderBlueprints(allPages);
        
        // Check for sheet parameter in URL
        const urlParams = new URLSearchParams(window.location.search);
        const sheetNum = urlParams.get('sheet');
        if (sheetNum) {
          const page = allPages.find(p => p.sheet_num === sheetNum);
          if (page) {
            openModal(page);
          }
        }
        
      } catch (err) {
        console.error('Failed to load blueprints:', err);
      }
    }
    
    function renderBlueprints(pages) {
      const grid = document.getElementById('blueprintsGrid');
      
      if (pages.length === 0) {
        grid.innerHTML = '<div style="text-align:center;padding:40px;color:#8a98ab">No blueprints found</div>';
        return;
      }
      
      grid.innerHTML = pages.map(page => {
        // Use the image_path from the JSON
        const imgPath = page.image_path || `blueprints/classified/${page.category}/${page.filename}`;
        
        return `
          <div class="blueprint-card" onclick="openModal(${JSON.stringify(page).replace(/"/g, '&quot;')})">
            <img class="blueprint-img" src="${imgPath}" alt="${page.sheet_num}" 
                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22220%22%3E%3Crect fill=%22%230a0e27%22 width=%22300%22 height=%22220%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23667eea%22 text-anchor=%22middle%22 dy=%22.3em%22 font-family=%22system-ui%22%3E${page.sheet_num}%3C/text%3E%3C/svg%3E'">
            <div class="blueprint-info">
              <div class="blueprint-sheet">${page.sheet_num}</div>
              <div class="blueprint-title">${page.title}</div>
              <div class="blueprint-category">${page.category}</div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function openModal(page) {
      const modal = document.getElementById('modal');
      const imgPath = page.image_path || `blueprints/classified/${page.category}/${page.filename}`;
      
      document.getElementById('modalImg').src = imgPath;
      document.getElementById('modalInfo').innerHTML = `
        <h2>${page.sheet_num}: ${page.title}</h2>
        <p>${page.category} ‚Ä¢ Page ${page.page_num}</p>
      `;
      modal.style.display = 'block';
    }
    
    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }
    
    function filterBlueprints() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const selectedCategory = document.getElementById('categoryFilter').value;
      
      const filtered = allPages.filter(page => {
        const matchesSearch = page.sheet_num.toLowerCase().includes(searchTerm) ||
                            page.title.toLowerCase().includes(searchTerm);
        const matchesCategory = !currentCategory || page.category === currentCategory;
        const matchesDropdown = !selectedCategory || page.category === selectedCategory;
        return matchesSearch && matchesCategory && matchesDropdown;
      });
      
      renderBlueprints(filtered);
    }
    
    document.getElementById('searchInput').addEventListener('input', filterBlueprints);
    document.getElementById('categoryFilter').addEventListener('change', filterBlueprints);
    
    // Close modal on outside click
    window.onclick = function(event) {
      const modal = document.getElementById('modal');
      if (event.target === modal) {
        closeModal();
      }
    }
    
    loadBlueprints();
  </script>
</body>
</html>

